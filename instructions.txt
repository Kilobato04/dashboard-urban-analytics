# ğŸ“ Estructura de Carpetas - Urban Analytics Dashboard

## Estructura Recomendada del Proyecto

```
urban-analytics-dashboard/
â”œâ”€â”€ index.html                          # â† HTML principal (sin datos hardcodeados)
â”œâ”€â”€ styles.css                          # â† CSS existente
â”œâ”€â”€ script.js                           # â† Script principal actualizado
â”œâ”€â”€ urban-analytics-storage.js          # â† Sistema de storage (NUEVO)
â”œâ”€â”€ api/
â”‚   â””â”€â”€ save_data.php                   # â† API para guardar/cargar datos (NUEVO)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ urban_analytics_data.json      # â† Datos guardados (se crea automÃ¡ticamente)
â”œâ”€â”€ backup/                             # â† Carpeta para backups (opcional)
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ plotly.min.js              # â† Para grÃ¡ficas (si es necesario)
â””â”€â”€ README.md                          # â† DocumentaciÃ³n
```

## ğŸ“‹ Archivos Principales

### 1. **index.html**
- âœ… **Eliminados**: Todos los datos hardcodeados de las tablas
- âœ… **Agregado**: Indicador de estado de conexiÃ³n
- âœ… **Agregado**: BotÃ³n de guardado manual funcional
- âœ… **Agregado**: InclusiÃ³n del script de storage

### 2. **urban-analytics-storage.js** (NUEVO)
- âœ… **Funcionalidad**: Sistema completo de guardado/carga
- âœ… **CaracterÃ­sticas**:
  - Guardado automÃ¡tico en servidor
  - Carga al inicializar
  - DetecciÃ³n de cambios
  - Notificaciones al usuario
  - Manejo de errores
  - Modo offline

### 3. **script.js** (ACTUALIZADO)
- âœ… **Integrado**: Con sistema de storage
- âœ… **Agregado**: Marcado de cambios para guardado
- âœ… **Mantenido**: Todas las funcionalidades existentes
- âœ… **Mejorado**: Event listeners y detecciÃ³n de cambios

### 4. **api/save_data.php** (NUEVO)
- âœ… **Funcionalidad**: API REST para guardar/cargar datos
- âœ… **CaracterÃ­sticas**:
  - ValidaciÃ³n de datos
  - Manejo de errores
  - Headers CORS
  - Respuestas JSON estructuradas

## ğŸ”§ ConfiguraciÃ³n del Servidor

### Para Netlify (Recomendado)
1. **Crear archivo `netlify.toml`**:
```toml
[build]
  functions = "netlify/functions"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
```

2. **Crear funciÃ³n serverless**: `netlify/functions/save_data.js`
```javascript
const fs = require('fs');
const path = require('path');

exports.handler = async (event, context) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Content-Type': 'application/json'
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  const dataPath = '/tmp/urban_analytics_data.json';

  try {
    if (event.httpMethod === 'POST') {
      // Guardar datos
      const data = JSON.parse(event.body);
      data.metadata.lastSaved = new Date().toISOString();
      
      fs.writeFileSync(dataPath, JSON.stringify(data, null, 2));
      
      return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
          success: true,
          message: 'Data saved successfully',
          timestamp: data.metadata.lastSaved
        })
      };
    } else {
      // Cargar datos
      if (fs.existsSync(dataPath)) {
        const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
        return {
          statusCode: 200,
          headers,
          body: JSON.stringify({
            success: true,
            data: data,
            message: 'Data loaded successfully'
          })
        };
      } else {
        return {
          statusCode: 200,
          headers,
          body: JSON.stringify({
            success: true,
            data: null,
            message: 'No saved data found'
          })
        };
      }
    }
  } catch (error) {
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({
        success: false,
        error: error.message
      })
    };
  }
};
```

### Para Servidor Web Tradicional
- Usar el archivo `api/save_data.php` proporcionado
- Asegurar que el servidor tenga permisos de escritura en la carpeta `data/`
- Configurar PHP 7.4+ con soporte JSON

## ğŸ“Š Ejemplo de Estructura de Datos JSON

```json
{
  "metadata": {
    "version": "1.0",
    "lastSaved": "2024-01-15T10:30:00.000Z",
    "appName": "Urban Analytics Mexico Dashboard"
  },
  "pipeline": {
    "current": [
      {
        "id": "pipeline_1",
        "number": "1",
        "project": "Seattle - WSF",
        "topic": "Demand Modeling",
        "client": "CrossColab",
        "lead": "Roberto",
        "support": "None",
        "date": "2025-07-15",
        "price": 55000,
        "probability": 60,
        "weightedValue": 33000
      }
    ],
    "eoi": [],
    "ongoing": [],
    "lost": []
  },
  "progress": {
    "exercised": 0,
    "backlog": 0,
    "potential": 33000,
    "target": 300000,
    "teamCost": 240000
  },
  "tactics": {
    "octavio": {
      "q2": [
        {
          "text": "Lead 2 proposals worth $25K each",
          "completed": false
        }
      ],
      "q3": [],
      "q4": []
    }
  },
  "evaluation": {
    "opportunityName": "",
    "criteria": [],
    "finalScore": "5.00",
    "totalWeight": "100",
    "recommendation": "NO GO"
  },
  "settings": {
    "autoSave": false,
    "manualSaveOnly": true
  }
}
```

## ğŸš€ Pasos de ImplementaciÃ³n

### 1. **PreparaciÃ³n**
```bash
# Crear estructura de carpetas
mkdir urban-analytics-dashboard
cd urban-analytics-dashboard
mkdir api data backup assets/js
```

### 2. **Subir Archivos**
- Colocar `index.html` en la raÃ­z
- Colocar `urban-analytics-storage.js` en la raÃ­z
- Colocar `script.js` actualizado en la raÃ­z
- Colocar `api/save_data.php` en la carpeta api/

### 3. **Configurar Permisos** (Para PHP)
```bash
chmod 755 api/
chmod 666 data/
```

### 4. **Probar Funcionalidad**
- Abrir el dashboard en el navegador
- Verificar que aparezca "ğŸŒ Conectado" en el header
- Agregar un proyecto en el pipeline
- Presionar "ğŸ’¾ Save Changes"
- Verificar que aparezca "âœ… Guardado exitoso"
- Recargar la pÃ¡gina y verificar que los datos persisten

## ğŸ” VerificaciÃ³n de Funcionamiento

### Indicadores de Estado
- **ğŸŒ Conectado**: Sistema conectado al servidor
- **ğŸ“± Sin conexiÃ³n**: Modo offline
- **âœ… Sincronizado**: Datos guardados exitosamente
- **âš ï¸ Cambios pendientes**: Hay cambios sin guardar

### Pruebas Recomendadas
1. **Agregar proyecto**: âœ… Debe guardarse automÃ¡ticamente
2. **Modificar datos**: âœ… Debe marcar cambios pendientes
3. **Guardar manual**: âœ… Debe confirmar guardado exitoso
4. **Recargar pÃ¡gina**: âœ… Debe cargar datos guardados
5. **Modo offline**: âœ… Debe mostrar notificaciÃ³n apropiada

## ğŸ“ˆ Beneficios del Nuevo Sistema

### âœ… **Ventajas Implementadas**
- **Persistencia**: Los datos se guardan en servidor
- **Confiabilidad**: Sistema robusto de guardado/carga
- **Notificaciones**: Feedback claro al usuario
- **Modo offline**: Funciona sin conexiÃ³n
- **DetecciÃ³n automÃ¡tica**: Marca cambios automÃ¡ticamente
- **Backup**: Datos respaldados en servidor

### ğŸ”„ **Flujo de Trabajo Mejorado**
1. Usuario abre dashboard â†’ Carga datos del servidor
2. Usuario modifica datos â†’ Marca cambios pendientes
3. Usuario presiona guardar â†’ EnvÃ­a datos al servidor
4. Sistema confirma guardado â†’ Usuario ve confirmaciÃ³n
5. Usuario cierra/recarga â†’ Datos persisten correctamente

## ğŸ¯ **Resultado Final**
Dashboard completamente funcional con:
- âœ… Sin datos hardcodeados
- âœ… Guardado automÃ¡tico en servidor
- âœ… Carga automÃ¡tica al inicializar
- âœ… BotÃ³n de guardado manual
- âœ… Indicadores de estado
- âœ… Notificaciones al usuario
- âœ… Manejo de errores
- âœ… Compatibilidad con Netlify y servidores PHP
